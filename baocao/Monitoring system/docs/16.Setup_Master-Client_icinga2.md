### Add Remote Linux Machines into Monitoring 

### A. Mô hình

- Node master :
	- Hostname : host52
	- IP : 10.2.9.52
	- Os : CentOS 7
- Node Client : 
	- Hostname : host51
	- IP : 10.2.9.51
	- Os : CentOS 7
- Node Client 
	- Hostname : host50
	- IP : 10.2.9.50
	- Os : CentOS 7

### B. Cài đặt

### 1. Thực hiện trên node master

```
icinga2 node wizard



Welcome to the Icinga 2 Setup Wizard!

We will guide you through all required configuration details.

Please specify if this is a satellite/client setup ('n' installs a master setup) [Y/n]: n 					<< Setup Master

Starting the Master setup routine...

Please specify the common name (CN) [host52]: 											<< Press Enter
Reconfiguring Icinga...
Checking for existing certificates for common name 'server.itzgeek.local'...
Certificate '/var/lib/icinga2/certs//host52.crt' for CN 'server.itzgeek.local' already existing. Skipping certificate generation.
Generating master configuration for Icinga 2.
'api' feature already enabled.

Master zone name [master]: 													<< Press Enter

Default global zones: global-templates director-global
Do you want to specify additional global zones? [y/N]: N 									<< Press N and Enter
Please specify the API bind host/port (optional):
Bind Host []: 															<< Press Enter
Bind Port []: 															<< Press Enter

Do you want to disable the inclusion of the conf.d directory [Y/n]: 								Y << Press Y and Enter
Disabling the inclusion of the conf.d directory...
Checking if the api-users.conf file exists...

Done.

Now restart your Icinga 2 daemon to finish the installation!

```

### 2. Xem CA và các thoong tin cấu hình trong zone ( thực hiện trên master )
```
cat /etc/icinga2/constants.conf | egrep -i "ZoneName|TicketSalt"


cat /etc/icinga2/zones.conf

systemctl restart icinga2

```

### 3. Thực hiện Setup trên icinga Client

```
yum install epel-release

rpm --import https://packages.icinga.com/icinga.key

yum install https://packages.icinga.com/epel/icinga-rpm-release-7-latest.noarch.rpm

```

### 4. Thực hiện cài đặt Node trên Client
```

icinga2 node wizard



Welcome to the Icinga 2 Setup Wizard!

We will guide you through all required configuration details.

Please specify if this is a satellite/client setup ('n' installs a master setup) [Y/n]:					 Y << Setup Client

Starting the Client/Satellite setup routine...

Please specify the common name (CN) [host51]: 								<< Press Enter

Please specify the parent endpoint(s) (master or satellite) where this node should connect to:
Master/Satellite Common Name (CN from your master/satellite node): host52					<< Enter Master Node Name

Do you want to establish a connection to the parent node from this node? [Y/n]: 					Y << Press Y to accept connections
Please specify the master/satellite connection information:
Master/Satellite endpoint host (IP address or FQDN):10.2.9.52							        << Enter Master Node IP or Hostname
Master/Satellite endpoint port [5665]:											<< Press Enter

Add more master/satellite endpoints? [y/N]: 										N << Press N as we have only one master
Parent certificate information:

 Subject:     CN = host52
 Issuer:      CN = Icinga CA
 Valid From:  Sep  23 15:21:27 2018 GMT
 Valid Until: Aug 30 15:21:27 2033 GMT
 Fingerprint: D7 DC 2D 3A 0C A0 B5 01 FD FC 43 C4 00 B5 ED D0 32 01 E1 AC

Is this information correct? [y/N]: 											Y << Press Y if the above certificacte details are correct

Please specify the request ticket generated on your Icinga 2 master (optional).
 (Hint: # icinga2 pki ticket --cn 'host51'): 1a355c8e1afd6c2e7c6beb6ed803680a03aef7a7 			                << Copy/Paste the ticket from Master node ( Câu lệnh thực hiện trên master )
Please specify the API bind host/port (optional): 									<< Press Enter
Bind Host []: 														<< Press Enter
Bind Port []: 														<< Press Enter

Accept config from parent node? [y/N]: 											Y << Press Y to accept configuration
Accept commands from parent node? [y/N]: 										Y << Press Y to accept commands

Reconfiguring Icinga...
Disabling feature notification. Make sure to restart Icinga 2 for these changes to take effect.
Enabling feature api. Make sure to restart Icinga 2 for these changes to take effect.

Local zone name [host51]: 												<< Press Enter
Parent zone name [master]: 												<< Press Enter

Default global zones: global-templates director-global
Do you want to specify additional global zones? [y/N]: 									N << Press N

Do you want to disable the inclusion of the conf.d directory [Y/n]:							Y << Press Y to disable conf.d directory
Disabling the inclusion of the conf.d directory...

Done.

Now restart your Icinga 2 daemon to finish the installation!

```

### 5. Sau khi thực hiện lệnh ` icinga2 node wizard ` ta Configure cấu hình trong `/etc/icinga2/zone.conf ` của từng node Client như sau 
```
vi /etc/icinga2/zones.conf

/*
 * Generated by Icinga 2 node setup commands
 * on 2018-09-23 11:25:39 +0530
 */

object Endpoint "host52" {
        host = "10.2.9.52"
        port = "5665"
}

object Zone "master" {
        endpoints = [ "host52" ]
}

object Endpoint "host51" {
}

object Zone "host51" {
        endpoints = [ "host51" ]
        parent = "master"
}

```

- Restart Icinga2
` systemctl restart icinga2 `


### 6. Setup Master with Client ( Thực hiện trên master )

```
mkdir -p /etc/icinga2/zones.d/master
 
vi /etc/icinga2/zones.d/master/host51.conf         # File cấu hình của từng node


object Endpoint "host51" {
}

object Zone "host51" {
     endpoints = [ "host51" ]
     parent = "master"
}

// Host Objects
object Host "host51" {
    check_command = "hostalive"
    address = "10.2.9.51"
    vars.client_endpoint = name //follows the convention that host name == endpoint name

// Custom Optional check - START
    vars.local_disks["/app Filesystem"] = {
       disk_partitions = "/app"
  }

    vars.local_http_vhosts["http"] = {
       http_uri = "/"
  }

    vars.local_tcp_port["tcp"] ={
       tcp_port = "23"
       service_name = "Telnet Check"
       port_number = "Port 23"
  }
// Custom Optional Check - END
}



```

- Tương tự với Node client khác

```

vi /etc/icinga2/zones.d/master/host50.conf

object Endpoint "host50" {
}

object Zone "host50" {
     endpoints = [ "host50" ]
     parent = "master"
}

// Host Objects
object Host "host50" {
    check_command = "hostalive"
    address = "10.2.9.50"
    vars.client_endpoint = name //follows the convention that host name == endpoint name
}


```
- Add thêm cấu hình của node Master

```
vi /etc/icinga2/zones.d/master/master.conf


object Host "host52" {
    check_command = "hostalive"
    address = "10.2.9.52"
    vars.client_endpoint = name //follows the convention that host name == endpoint name
}


```

- Add các service check 

```
vi /etc/icinga2/zones.d/master/services.conf


// Ping Check
apply Service "Ping" {
  check_command = "ping4"
  assign where host.address // check is executed on the master node
}

// System Load
apply Service "System Load" {
  check_command = "load"
  command_endpoint = host.vars.client_endpoint // Check executed on client node
  assign where host.vars.client_endpoint
}

// System Process Count
apply Service "Process" {
  check_command = "procs"
  command_endpoint = host.vars.client_endpoint
  assign where host.vars.client_endpoint
}

// Logged in User Count
apply Service "Users" {
  check_command = "users"
  command_endpoint = host.vars.client_endpoint
  assign where host.vars.client_endpoint
}

// Disk Usage Check
apply Service "Disk" {
  check_command = "disk"
  command_endpoint = host.vars.client_endpoint
  assign where host.vars.client_endpoint
}

// Disk Usage Check for Specific Partition
apply Service for (disk => config in host.vars.local_disks) {
  check_command = "disk"
  vars += config
  command_endpoint = host.vars.client_endpoint
  assign where host.vars.client_endpoint
}

// System Swap Check
apply Service "SWAP" {
  check_command = "swap"
  command_endpoint = host.vars.client_endpoint
  assign where host.vars.client_endpoint
}

// SSH Service Check
apply Service "SSH Service" {
  check_command = "ssh"
  command_endpoint = host.vars.client_endpoint
  assign where host.vars.client_endpoint

}

// FTP Service Check
apply Service "FTP Service" {
  check_command = "ftp"
  command_endpoint = host.vars.client_endpoint
  assign where host.vars.client_endpoint

}

// Icinga 2 Service Check
apply Service "Icinga2 Service" {
  check_command = "icinga"
  command_endpoint = host.vars.client_endpoint
  assign where host.vars.client_endpoint
}

// Apache VirtualHost Check
apply Service for (http_vhost => config in host.vars.local_http_vhosts) {
  check_command = "http"
  vars += config
  command_endpoint = host.vars.client_endpoint
  assign where host.vars.client_endpoint
}

// TCP Port Check
apply Service for (tcp_port => config in host.vars.local_tcp_port) {
  check_command = "tcp"
  vars += config
  display_name = + vars.service_name + " - " + vars.port_number
  command_endpoint = host.vars.client_endpoint
  assign where host.vars.client_endpoint
}

```
- Kiểm tra cấu hình bằng lệnh
` icinga2 daemon -C `

- Thực hiện phân quyền cho thư mục `/etc/icinga2/zones.d/master/ ` và restart Icinga
```
chown -R icinga:icinga /etc/icinga2/zones.d/master/ 

systemctl restart icinga2

```



#### Tài liệu tham khảo : https://www.itzgeek.com/how-tos/linux/how-to-add-remote-linux-host-into-icinga-2-server.html/3









































































